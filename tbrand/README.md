Title: Crystalのマクロでライブラリ作成
Author: Taichiro Suzuki / @tbrand_dev

# Crystalのマクロでライブラリ作成

初めまして、@taichiro_devと申します.仕事は主にRuby・Android・iOSです.
これまで言語自体にはそんなに関心がなかった私でも、Crystalには初めて知ったときからずっと魅了されてきました.
Crystal自体の魅力は他の方に語っていただくとして、今回は主にCrystalのマクロの魅力について私なりに書かせていただきたいと思います.

## マクロでできること

マクロとは簡単に言うとプログラムを書くプログラムです.
これに尽きると思います.

## Crystalのマクロを書いてみる

では早速、実際にマクロを書いてみます.
まずは**とてもくだらない例**を示します.
次のような関数について考えます.
```crystal
def hoge
  puts "HOGE!"
end
```
マクロはプログラムを書くプログラムなのですから、当然この`hoge`関数を書くこともできます.
次のように書きます.
```crystal
macro define_hoge
  def hoge
    puts "HOGE!"
  end
end

define_hoge

hoge
# => "HOGE!"
```
この`define_hoge`というのがマクロです.
`define_hoge`マクロを呼び出すことで、中身(ここでは`hoge`関数)をソースコードに書き込みます.

ただこれでは冗長なだけで、何のためにマクロがあるのか全くわかりません.
もう少し実用的なマクロを書いてみましょう.
String型(`"ok"`)の変数をSymbol型(`:ok`)に変換しようと思います.
```crystal
macro string_to_symbol(str)
  :{{str.id}}
end

ok = string_to_symbol("ok")
puts typeof(ok)
# => Symbol
```
`string_to_symbol`マクロは`str`を引数に取ります.
`str`は任意のStringです.(実はStringではなくても良いです.)
マクロの中では引数を`{{}}`で囲むことでその引数を使用することができます.
`.id`というのは簡単に言うと中身を取り出しています.
つまり`:{{str.id}}`は、`str`の中身を取り出して先頭に`:`をつける、ということを行っております.
これで晴れて`"ok"`は`:ok`となるわけです.

最後の例として、マクロの中でfor文を使用したいと思います.
次のように使用します.
```
macro puts_all(*nums)
  {% for n in nums %}
    puts "{{n.id}}"
  {% end %}
end

puts_all(1, "2", 3)
# =>
1
2
3
```
`puts_all`マクロは引数を全て`puts`で表示するマクロで、引数`*nums`の`*`は可変長引数という意味です.
マクロの中でfor文は`{% for ... %}`のように使います.なお`{% %}`で挟まれた文は`{{ }}`とは違いソースコードには書き込まれません.
ここまでの例で、マクロはプログラムを書くプログラムということをご理解いただけましたでしょうか.

Crystalが標準で用意しているマクロもあります.
`getter setter property record`

他にも様々なマクロの文法があります.
興味を持った方はCrystalのソースコードを読んでみてはいかがでしょうか.
Crystalはセルフホスティングなので、ソースコードが読みやすいというのも魅力の一つです.

## ライブラリの設計にどう使用するか

結論から言うと、私自身も試行錯誤行っている段階で、まだ正解を得られていません.
なので、ボトムアップに説明することは難しいです.
実際に私が開発している`topaz-crystal/topaz`というライブラリでどのようにマクロを使用しているかを説明したいと思います.
なお、topaz自体の機能の説明は省略させていただきたいと思います.
また、簡単のために実際のコードとは違うコードになっているところもございます.m(__)m

・親クラスを定義、それを継承するとマクロを使用できる
```
macro expand_methods
  def method_a
  end
  def method_b
  end
  def method_c
  end
end
```
・コンストラクタ
・ある意味めちゃくちゃな使い方`set_value_of(str, value)`

このようにマクロを使用するとユーザーフレンドリーなライブラリ設計をすることができます.
ぜひともTopazにフィードバックくださいm(__)m
